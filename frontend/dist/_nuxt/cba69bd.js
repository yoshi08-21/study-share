(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{822:function(e,t,r){"use strict";r.r(t);var o=r(265),n=r(255),c=r(111),l=r(566),d=r(262),f=r(209),h=r(597),v=r(804),m=r(803),k=r(565),_=r(567),y=r(778),x=r(162),w=(r(35),r(13),r(83),r(47),r(70),r(90),r(26)),j=(r(82),r(55),r(6),r(49),r(56),r(367),r(40),r(61),r(33),r(71),r(119)),C=r(44);function S(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,c=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return c=e.done,e},e:function(e){l=!0,n=e},f:function(){try{c||null==r.return||r.return()}finally{if(l)throw n}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}var B={mixins:[j.a],data:function(){return{keyword:"",searchResults:[],bookDialog:!1,book:{},items:["英語","数学","国語","社会","理科"],subject:"",perPage:10,page:1,cleanedErrorMessage:"",selectSubjectDialog:!1,categories:[{name:"国語",subcategories:["現代文","古文","漢文"]},{name:"社会",subcategories:["日本史","世界史","地理","倫理・政治経済"]},{name:"数学",subcategories:["数学I・A","数学Ⅱ・B","数学Ⅲ・C"]},{name:"英語",subcategories:["英文法","英文読解","英作文","英単語","リスニング"]},{name:"理科",subcategories:["物理","生物","化学","地学"]},{name:"その他",subcategories:["過去問","小論文","その他科目"]}],isInputBeingConverted:!1,isSearching:!1}},computed:{booksChunk:function(){var e=(this.page-1)*this.perPage,t=e+this.perPage;return this.searchResults.slice(e,t)},totalPages:function(){return Math.ceil(this.searchResults.length/this.perPage)}},methods:{searchBooks:function(){var e=this;return Object(w.a)(regeneratorRuntime.mark((function t(){var r,o,n,data,c,l,d,f,h,v,m,k;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!1!==e.isInputBeingConverted){t.next=14;break}return e.searchResults=[],"https://www.googleapis.com/books/v1/volumes?",r={q:"intitle:".concat(e.keyword),maxResults:40},o=new URLSearchParams(r),t.next=8,fetch("https://www.googleapis.com/books/v1/volumes?"+o);case 8:return n=t.sent,t.next=11,n.json();case 11:if((data=t.sent).items){c=S(data.items);try{for(c.s();!(l=c.n()).done;)d=l.value,f=d.volumeInfo.title,h=d.volumeInfo.author,v=d.volumeInfo.publisher,m=d.volumeInfo.imageLinks,k=d.volumeInfo.description,e.searchResults.push({name:f||"不明",author:h||"不明",publisher:v||"不明",imageUrl:m?m.thumbnail:"",description:k?k.slice(0,40):"",fullDescription:k?k.slice(0,1e3):""})}catch(e){c.e(e)}finally{c.f()}}else e.isSearching=!0;e.page=1;case 14:t.next=19;break;case 16:t.prev=16,t.t0=t.catch(0),console.error("エラーが発生しました:",t.t0);case 19:case"end":return t.stop()}}),t,null,[[0,16]])})))()},openBookDialog:function(e){this.book=e,this.subject="",this.bookDialog=!0},downloadImageFromUrl:function(e){return Object(w.a)(regeneratorRuntime.mark((function t(){var r,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fetch(e);case 2:return r=t.sent,t.next=5,r.blob();case 5:return o=t.sent,t.abrupt("return",new File([o],"downloaded-image.jpg",{type:o.type}));case 7:case"end":return t.stop()}}),t)})))()},submitBook:function(e){var t=this;return Object(w.a)(regeneratorRuntime.mark((function r(){var o,n,c,l,d,f,h,v,m;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if((o=new FormData).append("current_user_id",t.currentUser.id),o.append("book[name]",e.name),o.append("book[author]",e.author),o.append("book[publisher]",e.publisher),o.append("book[subject]",t.subject),o.append("book[description]",e.fullDescription),!e.imageUrl){r.next=14;break}return n=encodeURIComponent(e.imageUrl),r.next=11,C.a.get("/books/download_book_image?image_url=".concat(n),{responseType:"blob"});case 11:c=r.sent,l=new Blob([c.data],{type:c.headers["content-type"]}),o.append("book[image]",l,"downloaded-image.jpg");case 14:return r.prev=14,r.next=17,C.a.post("/books",o);case 17:d=r.sent,t.$router.push({path:"/books/".concat(d.data.id),query:{message:"参考書の登録が完了しました"}}),r.next=24;break;case 21:if(r.prev=21,r.t0=r.catch(14),r.t0.response&&r.t0.response.data){f=r.t0.response.data.errors,h=S(f);try{for(h.s();!(v=h.n()).done;)(m=v.value).includes("Name")&&(t.cleanedErrorMessage=m.replace("Name ",""))}catch(e){h.e(e)}finally{h.f()}console.error(t.cleanedErrorMessage),t.snackbarColor="red accent-2",t.snackbar=!0,t.flashMessage=t.cleanedErrorMessage}else console.error("リクエストエラー:",r.t0);case 24:t.bookDialog=!1;case 25:case"end":return r.stop()}}),r,null,[[14,21]])})))()},closeBookDialog:function(){this.bookDialog=!1,this.subject=""}}},R=r(69),component=Object(R.a)(B,(function(){var e=this,t=e._self._c;return t("div",[t("br"),t("br"),e._v(" "),t(k.a,[t(l.a,{staticClass:"d-flex justify-center",attrs:{cols:"12"}},[t(n.a,{attrs:{height:"130px",width:"85%"}},[t(c.d,{staticStyle:{height:"100%","align-items":"center"}},[t(k.a,[t(l.a,{attrs:{cols:"11"}},[t(x.a,{attrs:{filled:"",outlined:"",dense:"",label:"参考書を検索","data-cy":"google-books-api-search-books"},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.searchBooks.apply(null,arguments)},compositionstart:function(t){e.isInputBeingConverted=!0},compositionend:function(t){e.isInputBeingConverted=!1}},model:{value:e.keyword,callback:function(t){e.keyword=t},expression:"keyword"}})],1),e._v(" "),t(l.a,{attrs:{cols:"1"}},[t(o.a,{attrs:{"data-cy":"google-books-api-search-button"},on:{click:e.searchBooks}},[e._v("検索")])],1)],1)],1)],1)],1)],1),e._v(" "),t("br"),t("br"),e._v(" "),0!==e.searchResults.length?[t(h.a,{attrs:{length:e.totalPages},model:{value:e.page,callback:function(t){e.page=t},expression:"page"}}),e._v(" "),t("br"),e._v(" "),e._l(e.booksChunk,(function(r,d){return t(k.a,{key:d,staticClass:"justify-center",attrs:{"mb-5":"","data-cy":"searched-books"}},[t(l.a,{attrs:{cols:"10"}},[t(n.a,{staticStyle:{"margin-bottom":"5px"},attrs:{elevation:"2","max-height":"300"}},[t(k.a,[t(l.a,{staticClass:"d-flex justify-center",attrs:{cols:"3"}},[r.imageUrl?t("div",{staticClass:"d-flex justify-center",staticStyle:{height:"210px"}},[t(f.a,{attrs:{src:r.imageUrl,alt:"画像",contain:"","max-height":"200","max-width":"180"}})],1):e._e()]),e._v(" "),t(l.a,{staticClass:"mt-n4",attrs:{cols:"9"}},[t("div",[t(c.d,[e._v("\n                  "+e._s(e.$truncate(r.name,100))+"\n                ")])],1),e._v(" "),t(c.c,[t("h4",[e._v("出版社: "+e._s(r.publisher))]),e._v(" "),t("h4",[e._v("著者: "+e._s(r.author))]),e._v(" "),t("br"),e._v(" "),t("p",[e._v("\n                  "+e._s(r.description)+"\n                ")])]),e._v(" "),t(c.a,[t(k.a,{staticClass:"d-flex align-center justify-center"},[t(l.a,{attrs:{cols:"4"}},[t(o.a,{attrs:{large:"","data-cy":"add-book"},on:{click:function(t){return e.openBookDialog(r)}}},[e._v("参考書を登録する")])],1)],1)],1)],1)],1)],1)],1)],1)})),e._v(" "),t("br"),e._v(" "),t(h.a,{attrs:{length:e.totalPages},model:{value:e.page,callback:function(t){e.page=t},expression:"page"}})]:0===e.searchResults.length&&!0===e.isSearching?[t("h2",{staticStyle:{"text-align":"center"}},[e._v("検索結果はありません")])]:e._e(),e._v(" "),t(d.a,{attrs:{"max-width":"1000px"},model:{value:e.bookDialog,callback:function(t){e.bookDialog=t},expression:"bookDialog"}},[t(k.a,[t(l.a,{attrs:{cols:"12"}},[e.book?t(n.a,[t(c.d,{staticStyle:{"justify-content":"center"}},[t("h2",[e._v("参考書を登録する")])]),e._v(" "),t(n.a,[t(k.a,[t(l.a,{attrs:{cols:"2"}},[e.book.imageUrl?t("div",{staticClass:"d-flex justify-center",staticStyle:{height:"210px"}},[t(f.a,{attrs:{src:e.book.imageUrl,alt:"画像",contain:"","max-height":"250","max-width":"230"}})],1):e._e()]),e._v(" "),t(l.a,{attrs:{cols:"10"}},[t(c.d,[e._v("\n                  タイトル: "+e._s(e.book.name)+"\n                ")]),e._v(" "),t(c.c,[t("p",[e._v("著者: "+e._s(e.book.author))]),e._v(" "),t("p",[e._v("出版社: "+e._s(e.book.publisher))]),e._v(" "),t("p",[e._v("説明文: "+e._s(e.book.fullDescription))])])],1)],1),e._v(" "),t("br"),e._v(" "),t(c.a,[t(k.a,{staticClass:"d-flex justify-center"},[t(l.a,{staticClass:"d-flex justify-center",attrs:{cols:"8"}},[t(n.a,{staticStyle:{padding:"10px"},attrs:{height:"100",width:"500",elevation:"0"}},[t(k.a,[t(l.a,{staticClass:"d-flex justify-center"},[t(o.a,{attrs:{block:""},on:{click:function(t){e.selectSubjectDialog=!0}}},[e._v("科目を選択する(必須)")])],1)],1),e._v(" "),t(k.a,[t(l.a,{staticClass:"d-flex justify-center"},[e.subject?t("h3",[e._v("選択された科目："+e._s(e.subject))]):e._e()])],1)],1)],1)],1)],1),e._v(" "),t("br"),e._v(" "),t(k.a,{staticClass:"d-flex justify-space-around"},[t(l.a,{staticClass:"d-flex justify-center",attrs:{cols:"6"}},[""==e.subject?[t(o.a,{attrs:{color:"primary",disabled:"",width:"400",large:""},on:{click:function(t){return e.submitBook(e.book)}}},[e._v("\n                    登録する\n                  ")])]:[t(o.a,{attrs:{color:"primary",width:"400",large:"","data-cy":"submit-book"},on:{click:function(t){return e.submitBook(e.book)}}},[e._v("\n                    登録する\n                  ")])]],2),e._v(" "),t(l.a,{staticClass:"d-flex justify-center",attrs:{cols:"6"}},[t(o.a,{attrs:{large:"",width:"400"},on:{click:e.closeBookDialog}},[e._v("\n                  戻る\n                ")])],1)],1)],1)],1):e._e()],1)],1)],1),e._v(" "),t(d.a,{attrs:{"max-width":"500px"},model:{value:e.selectSubjectDialog,callback:function(t){e.selectSubjectDialog=t},expression:"selectSubjectDialog"}},[t(n.a,[t(c.d,{staticClass:"headline"},[e._v("科目選択")]),e._v(" "),t(c.c,[t(m.a,{attrs:{"data-cy":"select-subject-group"},model:{value:e.subject,callback:function(t){e.subject=t},expression:"subject"}},[e._l(e.categories,(function(r){return[t("p",{key:r.name},[e._v(e._s(r.name))]),e._v(" "),e._l(r.subcategories,(function(e){return t(v.a,{key:e,attrs:{label:e,value:e}})}))]}))],2)],1),e._v(" "),t("h3",[e._v("選択された科目:"+e._s(e.subject))]),e._v(" "),t(c.a,[t(y.a),e._v(" "),t(o.a,{attrs:{color:"primary",block:"","data-cy":"close-select-subject-dialog"},on:{click:function(t){e.selectSubjectDialog=!1}}},[e._v("閉じる")])],1)],1)],1),e._v(" "),t("br"),e._v(" "),t(_.a,{attrs:{timeout:3e3,color:e.snackbarColor},model:{value:e.snackbar,callback:function(t){e.snackbar=t},expression:"snackbar"}},[e._v(e._s(e.flashMessage))])],2)}),[],!1,null,null,null);t.default=component.exports}}]);